---
title: "Is CitiBike an old boy's club?'"
author: "Matthew Upson"
date: "02/11/2014"
output:
  html_document:
    theme: spacelab
  pdf_document: default
---

```{r load_libraries,include=TRUE,echo=FALSE,message=FALSE,warning=FALSE,include=TRUE}
require(plyr)
require(dplyr)
require(lubridate)
#require(testthat)
#require(reshape2)
require(ggplot2)
require(ggmap)
#require(randomForest)
require(xtable)

load("bikes.RData")
```

One of the first things you notice when drilling down into the New York Citibike data, is that there are a lot more male users than female. It's quite a striking difference between the sexes, and has been picked up in the [media](http://nypost.com/2014/05/09/majority-of-citi-bike-users-are-men-study/). In this post I'm going to look at the way Citibike usage differs across the sexes.

There are two types of Citibike users: long-term `Subscribers` to the service, and short term `Customers` who might only buy a weekly pass. Limited information is collected from pass buyers, but `Subscribers` are asked for their gender and `birth_year`, so it is possible to drill into this question a little.

### Proportion of users

Let's start with the basics. Of the `r nrow(bikes)` journeys recorded so-far, men made more than three times as many journeys as women.


```{r gender_proportions,cache=FALSE,echo=TRUE,message=FALSE,warning=FALSE,include=TRUE}

# It is possible to call all the data from teh sql database, but much quicker to run it from an RData file

bikes %>%
  dplyr::group_by(
    gender
    ) %>%
  dplyr::summarise(
    count = n(),
    prop = paste(round((n()/nrow(bikes))*100),"%")
    )

```

So women have definitely been using the service less, but perhaps they have been slower to adopt the scheme? How is the proportion of total users from each sex changing over time?

Looking at the plot below, you can see the seasonal dip in short term pass users over winter (the grey region), and a consequent increase in the proportion of male users, but the proportion of female users is fairly constant at around 20%.

```{r gender_month_plot,cache=TRUE,echo=TRUE,message=FALSE,warning=FALSE,include=TRUE,fig.width=9}

ggplot(
  bla <- bikes %>%
    dplyr::mutate(
      my = format(starttime,"%Y-%m")
      ) %>%
    dplyr::group_by(
      my
      ) %>%
    dplyr::mutate(
      month_total = n()
      ) %>%
    dplyr::group_by(
      gender,
      add = TRUE
      ) %>%
    dplyr::mutate(
      prop = (n()/month_total)*100
      ) %>%
    dplyr::summarise(
      prop = mean(prop)
      ),
  aes(
    x = my,
    y = prop,
    fill = gender,
    group = gender,
    colour = gender
    )
  )+
  geom_area(
    alpha = 0.3
    )+
  ylab("Proportion of users (%)")+
  xlab("Year and Month")

```

Since many people seem to use Citibikes to get to work Monday - Friday, usage patterns may change at the weekend...

```{r gender_month_plot1,cache=TRUE,echo=TRUE,message=FALSE,warning=FALSE,include=TRUE,fig.width=9}

ggplot(
  bikes %>%
    dplyr::mutate(
      my = format(starttime,"%Y-%m"),
      wday = wday(starttime),
      we = ifelse(
        wday %in% c(1,7),
        "Weekend",
        "Weekday"
        )
      ) %>%
    dplyr::group_by(
      my,
      we
      ) %>%
    dplyr::mutate(
      month_total = n()
      ) %>%
    dplyr::group_by(
      gender,
      add = TRUE
      ) %>%
    dplyr::mutate(
      prop = (n()/month_total)*100
      ) %>%
    dplyr::summarise(
      prop = mean(prop)
      ),
  aes(
    x = my,
    y = prop,
    fill = gender,
    group = gender,
    colour = gender
    )
  )+
  geom_area(
    alpha = 0.3
    )+
  ylab("Proportion of users (%)")+
  xlab("Year and Month")+
  facet_wrap(
    ~we
    )

```

While there looks to be an increase in the proportion of `Customers` -- short term pass holders at the weekend, especially in the summer months, the overall proportion of female riders remains fairl constant at around 20%.

### Journey times

So we now know that men use Citibikes proportionally more than women, but is the way that they are using the bikes different? One of the other variables in the dataset, is journey time (`tripduration`) in seconds, this is a good start. Let's start with the numbers:

```{r}

bikes %>%
  dplyr::group_by(
    gender
    ) %>%
  dplyr::summarise(
    mean = round(mean(tripduration)),
    median = median(tripduration)
    )

```

So from a simple mean and median, it looks like womens' journeys tend to be longer than mens', but both are much shorter than then `NA`s - the unknowns which relate to short term pass holders, for whom data is not recorded. It is also clear that there is some serious skew to the distributions of journeys times, as the medians are not particularly close to the means.

Let's look at these probability distributions (note that for clarity I have trimmed the data to journeys of less than 3000 seconds or 50 minutes, as the vast majority of journeys are less than this).

```{r trip_duration_density1,cache=TRUE,message=FALSE,warning=FALSE,include=TRUE,echo=TRUE}

ggplot(
  data = bikes,
  aes(
    x = tripduration,
    colour = gender,
    fill = gender,
    )
  ) + 
  geom_density(
    alpha = 0.3
    ) +
  scale_x_continuous(
    limits = c(0,3000)
    ) +
  xlab("Trip duration (s)")

```

OK...so this is looking a bit more interesting. Two things come out of this plot. Firstly it is clear that the distribution of female journey times matches fairly closely to the distribution of male journey times: most journeys take less than around 500 seconds (about 8 minutes and 20 seconds) - although most female journeys take longer than most male journeys:


```{r trip_duration_density,cache=TRUE,message=FALSE,warning=FALSE,include=TRUE,echo=TRUE}

ggplot(
  data = bikes,
  aes(
    x = tripduration,
    colour = gender,
    fill = gender,
    )
  ) + 
  geom_density(
    alpha = 0.3
    ) +
  scale_x_continuous(
    limits = c(0,3000)
    ) +
  xlab("Trip duration (s)") +
  coord_cartesian(
    xlim = c(0,750),
    ylim = c(0.001,0.0014)
    )

```


There is much a lag to the curve compared to the male curve, and in general, female journey times are longer than male journey times. Of equal interest is the fact that the unknowns - represented by the grey shading - show a markedly different distribution. Although skewed, the distribution is much more symmetrical, with the most common journey time around 1250 seconds.

This suggests a markedly different pattern of use among customers buying short term passes for Citibikes. This makes sense, as the assumption would be that someone paying a subscription to Citibike is using the service regularly -- i.e. commuting, whilst short term pass buyers are more likely to be occasional users or tourists. This is something we can explore in more detail.

Knowing that weekends show a different pattern of usage, how does trip duration differ?

```{r}

bikes %>%
  dplyr::group_by(
    gender,
    we = ifelse(
      wday(starttime) %in% c(1,7),
      "Weekend",
      "Weekday"
      )
    ) %>%
  dplyr::summarise(
    mean = round(mean(tripduration)),
    median = median(tripduration)
    )

```

So journey times tend to be longer across the board - what about the distributions? 

```{r trip_duration_density_we,cache=TRUE,message=FALSE,warning=FALSE,include=TRUE,echo=TRUE}

ggplot(
  data = bikes %>%
    dplyr::mutate(
      wday = wday(stoptime),
      we = ifelse(
        (wday %in% c(1,7)),
        "Weekend",
        "Weekday"
        )
      ),
  aes(
    x = tripduration,
    colour = gender,
    fill = gender
    )
  ) + 
  geom_density(
    alpha = 0.3
    ) +
  scale_x_continuous(
    limits = c(0,3000)
    ) +
  xlab("Trip duration (s)") +
  facet_wrap(
    ~we
    )

```

So yes, as we might expect, people tend to either take longer journeys, or travel at a more leisurely pace at the weekend, or both.

One of the other variable recorded among regular subscribers, is year of birth. How does this affect things? In this case I've cut the data into bins of 0-10, 10-20, 20-30, 30-40, 40-50, 50-60, and 60-100 years; and again considered both weekdays and weekends. In this probabilitys, distribution, I have presented absolute values instead of probabilities, so you get a sense of the number of journeys within each group.


```{r tripdensity_we_age,cache=TRUE,message=FALSE,warning=FALSE,include=TRUE,echo=TRUE,fig.width=14,fig.height=10}


ggplot(
  data = bikes %>%
    dplyr::mutate(
      wday = wday(stoptime),
      we = ifelse(
        (wday %in% c(1,7)),
        "Weekend","Weekday"
        ),
      age = 2014 - as.numeric(birth_year),
      age_group = cut(age,c(10,20,30,40,50,60,100))
      ) %>%
    dplyr::filter(
      !is.na(age_group),
      !is.na(gender)
      ),
  aes(
    #y = tripduration,
    x = tripduration,
    colour = gender,
    fill = gender
    )
  ) + 
  geom_density(
    aes(y= ..count..),
    alpha = 0.3
    ) +
  scale_x_continuous(
    limits = c(0,3000)
    ) +
  xlab("Trip duration (s)") +
  facet_grid(
    we~age_group
    )+
  ylab("Count")

```

At the weekend, many fewer people travel, and the distribution of journey times is less strongly peaked. All commonsense if we accept the idea that most people who use citibike are doing so to commute.

Returning to the gender question for now though: so why is it that journey times among women tend to be longer than men. Are women going on longer journeys than men, or do they just ride slower?

This is a difficult question to answer. Whilst it is easier to know whether the journey time from A to B is longer for men or women, it is not easy to know if the journey was direct. We could simply average it, and hope for the best; given 11 million records, this would probably be good enough, but there is another way making use of the google maps api.

The google maps api can be queried for distance and cycling journey time between two points. By using this method for a subsample of journeys, we can filter those journeys which take less time than google suggests it should take, hence we can be more sure (although not absolutely so) that these journeys were direct. We can then have a look at the differences between journey times for men and women.

### Step One

Aggregate all observation by the journey made, and the hour when it was made:

```{r, eval=FALSE,echo=TRUE,include=TRUE}

biks_agg <- bikes %>%
  dplyr::mutate(
    journey = paste(
      start_hash,
      end_hash,
      sep = ""
      ),
    time = round_date(
      starttime,
      "hour"
      )
    ) %>%
  dplyr::filter(
    start_hash != end_hash
    ) %>%
  dplyr::group_by(
    gender,
    start_hash,
    end_hash,
    journey,
    time
    ) %>%
  dplyr::summarise(
    num = n(),
    dur = mean(tripduration)
    ) %>%
  dplyr::arrange(
    desc(num)
    )

# This takes quite a while, so let's save it out as an RData file so we don't have to do it again

save(
  bikes_agg, 
  file = "bikes_agg.RData"
  )


```

```{r,eval=TRUE,echo=FALSE,include=FALSE}
load("bla.RData")
bikes_agg <- bla
save(
  bikes_agg, 
  file = "bikes_agg.RData"
  )
```

### Step Two:

Create a dataframe of all unique journeys

* Load the stations data. This is relatively quick, so I'll just load it from the sql database.

```{r,load_stns,cache=TRUE,echo=TRUE,warning=FALSE,message=FALSE,include=TRUE}

nybikes_db <- src_sqlite(
  "~/Dropbox/R/Citibike/nybikes.db"
  )


stns_sql <- # convert db table to R dataframe
  tbl( # load a database table
    nybikes_db,
    sql("select * from stns")
    )


stns <- collect(stns_sql)

stns

```

* Create a table of all the unique journeys

```{r}
journeys <- bikes_agg %>% 
  dplyr::group_by() %>%
  dplyr::filter(start_hash != end_hash) %>%
  dplyr::mutate(
    start_hash = as.character(start_hash),
    end_hash = as.character(end_hash)
    ) %>%
  dplyr::group_by(
    start_hash,
    end_hash,
    journey
    ) %>%
  dplyr::summarise(
    nobs = n()
)
```

This gives `r nrow(journeys)` journeys out of a possible `r journeys$start_hash %>% unique(.) %>% length(.) %>% .^2`; plus it is possible for a journey to start and end at the same station, but we are not interested in those, as there is no way to know where someone has been.

* merge `journeys` and `stns` dataframes to give a table with the complete station and journey data. 

```{r}


journeys1 <- merge(
  journeys,
  stns,
  by.x = "start_hash",
  by.y = "hash"
  ) %>% 
  merge(
    .,
    stns,
    by.x = "end_hash",
    by.y = "hash"
    ) %>% 
  dplyr::select(
    journey,
    start_hash,
    start_id = id.x,
    start_name = name.x,
    start_lat = lat.x,
    start_lon = lon.x,
    end_id = id.y,
    end_name = name.y,
    end_lat = lat.y,
    end_lon = lon.y
    )

journeys1

```

* Query the google api and get journey times and distance for a subset of journeys.

The google api limits you to 2500 queries a day, so 2500 seems like a good subset of queries to make. Note that since we can just query the journey dataframe we created in the previous step, not the individual journeys themselves, so even though we only have 2500 tries, we will actually be looking at many more journeys. 

```{r}

# First pick a random subset of the dataset. Best to test this with just a few examples, so you know it is working, then query a larger amount when you are confident that you are not going to use all of your free queries in one go!!

journeys_subset <- journeys1 %>%
  sample_n(
    10
    )

# First organise start and end coordinates into a format that the api will like:

fromx <- paste(
  journeys_subset$start_lat, 
  journeys_subset$start_lon, 
  sep =  " "
  )

toy <- paste(
  journeys_subset$end_lat, 
  journeys_subset$end_lon, 
  sep = " "
  )

journey_times <- mapdist(
  from = fromx,
  to = toy,
  mode = "bicycling"
  )

journey_times

# Ok so then bind this to the journeys1 dataframe

journeys_merge <- tbl_df(
  cbind(
    journeys_subset,
    journey_times
    )
  )  %>%  
  dplyr::select(
    -from,-to,-km,-miles,-minutes,-hours
    )

journeys_merge

```












### Initial exploration

Ok so now that we know where the stations are...let's do something with it! Let's start some of the very simple questions...

```{r load_nybikes,cache=FALSE,echo=TRUE,message=FALSE,warning=FALSE,include=TRUE}

# It is possible to call all the data from teh sql database, but much quicker to run it from an RData file

load("bikes.RData")

# nybikes_db <- src_sqlite(
#   "~/Dropbox/R/Citibike/nybikes.db"
#   )
# 
# bikes_sql <- tbl( # load a database table
#     nybikes_db,
#     sql('select * from nybikes')
#     )
# 
# bikes <- collect(bikes_sql)
# 
# bikes <- bikes %>%
#   dplyr::mutate(
#     starttime = ymd_hms(starttime),
#     stoptime = ymd_hms(stoptime),
#     start_hash = factor(start_hash),
#     end_hash = factor(end_hash),
#     bikeid = factor(bikeid),
#     usertype = factor(usertype),
#     gender = factor(gender),
#     birth_year = ifelse(
#       birth_year == "\\N",
#       NA,
#       birth_year
#       ),
#     gender = mapvalues(
#       gender, 
#       from = c(0,1,2), 
#       to = c(NA,"M","F"))
#     )

```

### Some summary information...

* The first recorded bike trip was on `r min(bikes$starttime)`, the last recorded trip was `r max(bikes$starttime)`. 
* There are `r length(unique(bikes$bikeid))` individual bikes and `r length(unique(stns$hash))` base.
* 

```{r no_of_journeys_boxplot,cache=TRUE,message=FALSE,warning=FALSE,include=TRUE,echo=TRUE}

ggplot(
  bikes %>% 
    dplyr::group_by(
      bikeid,
      year = year(starttime),
      month = month(starttime) 
      ) %>%
    dplyr::summarise(
      n = length(bikeid)
      ),
  aes(
    y = n,
    x = ordered(month),
    fill = factor(year),
    color = factor(year)
    )
  )+
  geom_boxplot(
    alpha = 0.3,
    outlier.size = 0
    )+
  facet_wrap(~year)+ 
  ylab("Number of journeys per bike")+
  xlab("Month")
  


```

## Some initial questions questions

* Are there differences in the usage pattern of men and women?
* Are there differences in the usage pattern of people of different ages?
* Do subscribers and customers use the bikes in different ways?

```{r number_of_journeys,cache=TRUE,message=FALSE,warning=FALSE,include=TRUE,echo=TRUE}

ggplot(
  bikes %>%
    dplyr::group_by(
      # Round date values to the nearest first day of the month    
      year = ordered(year(starttime)),
      month = ordered(month(starttime))
      ) %>%
    dplyr::summarise(
      n = length(tripduration)
      ),
  aes(
    x = month,
    y = n,
    colour = year,
    group = year
    )
  )+
geom_line()+
  ylab(
    "Number of journeys"
    )+
  scale_y_continuous(
    labels = sprintf("%.0f",seq(20000,100000,20000))
    )
       

```

Starting with some simple questions:

* Do women spend longer on bikes than men?
* Are there differences in the number of subscribers among men and women?
* Do women use bikes at difference hours than men?
* What about on different days?

```{r eval=TRUE,cache=TRUE,message=FALSE,warning=FALSE,include=TRUE,echo=TRUE}

tapply(
  bikes$tripduration,
  bikes$gender,
  median
  )

# Ok so it looks like men spend longer on the bikes, by median
# But what proportion of users are women?

tapply(
  bikes$tripduration,
  bikes$gender,
  function(x) round(length(x)/nrow(bikes),2)
  )


#...let's plot this out
# This is likely to be quite slow, so lets take a random subsample of say 100000 
# journeys and use this to compute our density estimates
```







```{r cache=TRUE,message=FALSE,warning=FALSE,include=TRUE,echo=TRUE}
## Ok so far so good...women use the bikes more at weekends and weekdays...

ggplot(
  data = bikes %>% 
    dplyr::sample_n(
      size = 100000,
      replace = FALSE
      ) %>%
    dplyr::mutate(
      wday = wday(stoptime),
      we = ifelse(
        (wday %in% c(1,7)),
        "Weekend","Weekday"
        )
      ) %>%
    dplyr::group_by(
      gender,we
      ) %>%
    dplyr::summarise(
      prop = round(length(we)/100000,2)
      ),
  aes(
    #y = tripduration,
    y = prop,
    x = gender,
    colour = gender,
    fill = gender
    )
  ) + 
  geom_bar(
    alpha = 0.3,
    stat = "identity"
    ) +
  facet_wrap(
    ~we
    ) + 
  ylab("Proportion of total (sampled) journeys")


```

## New questions

* There are so many few female journeys than male journeys - but women tend to spend longer on the bikes? Where are they going? Does this mean that they are NOT commuting as much?
* Customer, as opposed to subscribers tend to have a longer journey duration. Who are these people? And where are they going? Can trends in when they make their journeys, and where they are going elucidate who these people are - are they tourists for instance?